import pandas as pd
from telethon.sync import TelegramClient
from telethon.tl.types import MessageService, MessageActionChatAddUser, MessageActionChatJoinedByLink, MessageActionChatDeleteUser
import time

# --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
api_id = 'YOUR_API_ID'
api_hash = 'YOUR_API_HASH'
target_group_name = 'Ù†Ø§Ù… Ø¯Ù‚ÛŒÙ‚ Ú¯Ø±ÙˆÙ‡'

client = TelegramClient('ultra_final_session', api_id, api_hash)

async def main():
    await client.start()
    
    # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú¯Ø±ÙˆÙ‡
    target_group = None
    async for dialog in client.iter_dialogs():
        if dialog.name == target_group_name:
            target_group = dialog.entity
            break

    if not target_group: return

    # Û±. Ú©Ø´ Ø§ÙˆÙ„ÛŒÙ‡ (Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ø³Ø±Ø¹Øª)
    user_cache = {}
    print("â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§ÛŒ ÙØ¹Ù„ÛŒ...")
    async for user in client.iter_participants(target_group):
        f_name = user.first_name or ""
        l_name = user.last_name or ""
        user_cache[user.id] = {
            'name': f"{f_name} {l_name}".strip(),
            'username': f"@{user.username}" if user.username else "No Username"
        }

    data = []
    print(f"ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...")

    async for message in client.iter_messages(target_group, limit=None):
        u_id = None
        
        # ØªØ´Ø®ÛŒØµ Ø¢ÛŒØ¯ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ùˆ Ø³ÛŒØ³ØªÙ…ÛŒ
        if isinstance(message, MessageService):
            action = message.action
            if isinstance(action, (MessageActionChatAddUser, MessageActionChatJoinedByLink)):
                u_id = action.users[0] if hasattr(action, 'users') else (message.from_id.user_id if message.from_id else None)
                msg_content = "ğŸ“¥ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡"
            elif isinstance(action, MessageActionChatDeleteUser):
                u_id = action.user_id
                msg_content = "ğŸ“¤ Ø®Ø±ÙˆØ¬/Ø­Ø°Ù Ø§Ø² Ú¯Ø±ÙˆÙ‡"
            else:
                u_id = getattr(message.from_id, 'user_id', None)
                msg_content = "âš™ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø³ÛŒØ³ØªÙ…ÛŒ"
        else:
            u_id = getattr(message.from_id, 'user_id', None)
            msg_content = message.text if message.text else "<Media/File>"

        # Û². Ø¨Ø±Ø±Ø³ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯: Ø§Ú¯Ø± Ø¯Ø± Ú©Ø´ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†
        if u_id and u_id not in user_cache:
            try:
                user_entity = await client.get_entity(u_id)
                f_name = user_entity.first_name or ""
                l_name = user_entity.last_name or ""
                user_cache[u_id] = {
                    'name': f"{f_name} {l_name}".strip() or "Deleted Account",
                    'username': f"@{user_entity.username}" if user_entity.username else "No Username"
                }
            except:
                user_cache[u_id] = {'name': "Ø­Ø³Ø§Ø¨ Ø­Ø°Ù Ø´Ø¯Ù‡", 'username': "N/A"}

        user_info = user_cache.get(u_id, {'name': 'Ù†Ø§Ù…Ø´Ø®Øµ', 'username': 'N/A'})

        data.append({
            'Full_Name': user_info['name'],
            'User_ID': u_id,
            'Username': user_info['username'],
            'Text_Message': str(msg_content).replace('\n', ' '),
            'Date': message.date.strftime("%Y-%m-%d %H:%M")
        })

    # Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ
    df = pd.DataFrame(data)
    # Ø§ØµÙ„Ø§Ø­ ÙØ±Ù…Øª Ø§Ø¹Ø¯Ø§Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ø¹Ù„Ù…ÛŒ (Ù…Ø«Ù„ 7.11E)
    df['User_ID'] = df['User_ID'].astype(str).str.replace('.0', '', regex=False)
    
    df.to_csv('telegram_perfect_report.csv', index=False, encoding='utf-8-sig', quoting=1)
    print("âœ¨ ÙØ§ÛŒÙ„ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ø¯Ù‚Øª Û±Û°Û°Ùª Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯: telegram_perfect_report.csv")

with client:
    client.loop.run_until_complete(main())
