
# Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø¹Ø¶Ø§ Ø¨Ø§ Ø¹Ú©Ø³ Ù¾Ø±ÙˆÙØ§ÛŒÙ„

import os
import cv2
import pandas as pd
import asyncio
from telethon import TelegramClient

# -------- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø´Ø®ØµÛŒ --------
api_id =   # â† Ø¹Ø¯Ø¯ Ø¨Ú¯Ø°Ø§Ø± (Ø¨Ø¯ÙˆÙ† Ú©ÙˆØªÛŒØ´Ù†)
api_hash = ""
target_group_name = "B1-B2- 16.01.2026 - 26 Dey"# --------------------------------

# Ù…Ø¯Ù„ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡ OpenCV (Ù¾Ø§ÛŒØ¯Ø§Ø± Ùˆ Ø¨Ø¯ÙˆÙ† Ø¯Ø±Ø¯Ø³Ø± Ù†Ø³Ø®Ù‡)
face_cascade = cv2.CascadeClassifier(
    cv2.data.haarcascades + 'haarcascade_frontalface_default.xml'
)

client = TelegramClient("final_stable_session", api_id, api_hash)


def has_face(image_path):
    try:
        image = cv2.imread(image_path)
        if image is None:
            return False

        gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)

        faces = face_cascade.detectMultiScale(
            gray,
            scaleFactor=1.1,
            minNeighbors=5,
            minSize=(30, 30)
        )

        return len(faces) > 0
    except:
        return False


async def main():
    await client.start()

    # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú¯Ø±ÙˆÙ‡
    target_group = None
    async for dialog in client.iter_dialogs():
        if dialog.name == target_group_name:
            target_group = dialog.entity
            break

    if not target_group:
        print("âŒ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    os.makedirs("member_photos", exist_ok=True)

    user_cache = {}
    print("â³ Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...")


    async for user in client.iter_participants(target_group):
        u_id = user.id

    # Ø§ÙˆÙ„ Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒÙ…
    first = user.first_name or ""
    last = user.last_name or ""
    full_name = f"{first} {last}".strip()

    # Ø§Ú¯Ø± Ù†Ø§Ù… Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø§Ø² username Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if not full_name and user.username:
        full_name = f"@{user.username}"

    # Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
    if not full_name and getattr(user, 'phone', None):
        full_name = user.phone

    # Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯ØŒ Ù†Ø§Ù… Ù¾ÛŒØ´ÙØ±Ø¶ Ø¨Ø¯Ù‡
    if not full_name:
        full_name = f"User_{u_id}"

    username = f"@{user.username}" if user.username else "N/A"
    phone = getattr(user, 'phone', "N/A")  # Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯

    user_cache[u_id] = {
        "name": full_name,
        "username": username,
        "phone": phone
    }


    # ---------- Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹Ø¶Ø§ Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³ ----------
    async for user in client.iter_participants(target_group):
        u_id = user.id
        full_name = f"{user.first_name or ''} {user.last_name or ''}".strip() or "User"
        username = f"@{user.username}" if user.username else "N/A"

        user_cache[u_id] = {
            "name": full_name,
            "username": username
        }

        try:
            photos = await client.get_profile_photos(user, limit=None)

            if photos:
                user_folder = f"member_photos/{u_id}"
                os.makedirs(user_folder, exist_ok=True)

                for i, photo in enumerate(photos):
                    path = await client.download_media(
                        photo,
                        file=f"{user_folder}/temp_{i}.jpg"
                    )

                    if path and has_face(path):
                        os.rename(path, f"{user_folder}/face_{i}.jpg")
                    elif path:
                        os.rename(path, f"{user_folder}/unknown_{i}.jpg")

            await asyncio.sleep(0.5)  # Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Flood ØªÙ„Ú¯Ø±Ø§Ù…

        except Exception:
            continue

    # ---------- Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ----------
    data = []

    async for message in client.iter_messages(target_group, limit=None):
        try:
            u_id = message.sender_id  # Ø±ÙˆØ´ ØµØ­ÛŒØ­ Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯

            info = user_cache.get(
                u_id,
                {"name": f"User_{u_id}", "username": "N/A"}
            )

            data.append({
                "Full_Name": info["name"],
                "User_ID": str(u_id),
                "Username": info["username"],
                "Phone": info.get("phone", "N/A"),  # Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
                "Text_Message": (
                    message.text.replace("\n", " ")
                    if message.text else "<Media>"
                ),
                "Date": message.date.strftime("%Y-%m-%d %H:%M")
            })

        except Exception:
            continue

    # Ø°Ø®ÛŒØ±Ù‡ CSV
    df = pd.DataFrame(data)
    # df.to_csv("final_report.csv",sep='^', index=False, encoding="utf-8-sig")
    df.to_csv('group_complete_report.csv', sep='^', index=False, encoding='utf-8-sig', quoting=1)
    print("âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø´Ø¯!")
    print("ğŸ“ Ù¾ÙˆØ´Ù‡ member_photos Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯")
    print("ğŸ“„ ÙØ§ÛŒÙ„ final_report.csv Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯")


if __name__ == "__main__":
    asyncio.run(main())

