

import pandas as pd
from telethon.sync import TelegramClient
from telethon.tl.types import MessageService, MessageActionChatAddUser, MessageActionChatJoinedByLink, MessageActionChatDeleteUser
import asyncio

api_id = ''
api_hash = ''
target_group_name ='Ø§ÛŒØ±Ø§Ù† Ø¢ÙˆØ³Ø¨ÛŒÙ„Ø¯ÙˆÙ†Ú¯ | Iran Ausbildung'
client = TelegramClient('stable_session', api_id, 'api_hash')
async def main():
    await client.start()
    
    # Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ú¯Ø±ÙˆÙ‡
    target_group = None
    async for dialog in client.iter_dialogs():
        if dialog.name == target_group_name:
            target_group = dialog.entity
            break

    if not target_group:
        print("âŒ Ú¯Ø±ÙˆÙ‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!")
        return

    # Û±. Ú©Ø´ Ú©Ø±Ø¯Ù† Ø§Ø¹Ø¶Ø§ÛŒ ÙØ¹Ù„ÛŒ
    user_cache = {}
    print("â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ø¹Ø¶Ø§ÛŒ ÙØ¹Ù„ÛŒ...")
    async for user in client.iter_participants(target_group):
        user_cache[user.id] = {
            'name': f"{user.first_name or ''} {user.last_name or ''}".strip() or "User",
            'username': f"@{user.username}" if user.username else "N/A"
        }

    data = []
    print(f"ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§...")

    count = 0
    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¬Ø²ÛŒÛŒØ§Øª Ú©Ø§Ù…Ù„ Ù¾ÛŒØ§Ù… (GetFullSender)
    async for message in client.iter_messages(target_group, limit=1000):
        try:
            sender = await message.get_sender()
            
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¢ÛŒØ¯ÛŒ
            u_id = sender.id if sender else (message.from_id.user_id if hasattr(message.from_id, 'user_id') else None)
            
            # Ø§Ú¯Ø± Ø¯Ø± Ú©Ø´ Ù†Ø¨ÙˆØ¯ØŒ Ù…Ø´Ø®ØµØ§Øª Ø±Ø§ Ø§Ø² Ø®ÙˆØ¯ ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ù¾ÛŒØ§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†
            if sender and u_id not in user_cache:
                f_name = getattr(sender, 'first_name', '') or ""
                l_name = getattr(sender, 'last_name', '') or ""
                user_cache[u_id] = {
                    'name': f"{f_name} {l_name}".strip() or f"User_{u_id}",
                    'username': f"@{sender.username}" if getattr(sender, 'username', None) else "N/A"
                }

            # ØªØ´Ø®ÛŒØµ Ù…Ø­ØªÙˆØ§ Ùˆ ÙØ¹Ø§Ù„ÛŒØª
            activity = "Ù¾ÛŒØ§Ù… Ù…Ø¹Ù…ÙˆÙ„ÛŒ"
            msg_content = message.text if message.text else "<Media/File>"
            
            if isinstance(message, MessageService):
                action = message.action
                if isinstance(action, (MessageActionChatAddUser, MessageActionChatJoinedByLink)):
                    activity = "ÙˆØ±ÙˆØ¯"
                    msg_content = "ğŸ“¥ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú¯Ø±ÙˆÙ‡"
                elif isinstance(action, MessageActionChatDeleteUser):
                    activity = "Ø®Ø±ÙˆØ¬"
                    msg_content = "ğŸ“¤ Ø®Ø±ÙˆØ¬/Ø­Ø°Ù"

            # Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            info = user_cache.get(u_id, {'name': f"User_{u_id}", 'username': "N/A"})

            data.append({
                'Full_Name': info['name'],
                'User_ID': str(u_id),
                'Username': info['username'],
                'Activity': activity,
                'Text_Message': str(msg_content).replace('\n', ' '),
                'Date': message.date.strftime("%Y-%m-%d %H:%M")
            })

            count += 1
            if count % 1000 == 0:
                print(f"âœ… {count} Ù¾ÛŒØ§Ù… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯...")

        except Exception as e:
            # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ÛŒ Ù…ÙˆÙ‚Øª ØªÙ„Ú¯Ø±Ø§Ù…ØŒ Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†
            if "FloodWait" in str(e):
                await asyncio.sleep(10)
            continue

    # Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ
    df = pd.DataFrame(data)
    df.to_csv('telegram_ultimate_report.csv', index=False, encoding='utf-8-sig', quoting=1)
    print(f"âœ¨ ØªÙ…Ø§Ù… Ø´Ø¯! Û±Û¹Û° Ù‡Ø²Ø§Ø± Ù¾ÛŒØ§Ù… Ø¨Ø§ ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ø¯Ø± 'telegram_ultimate_report.csv' Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.")

with client:
    client.loop.run_until_complete(main())


    
